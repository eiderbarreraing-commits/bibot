{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-key me-2"></i>Configurar Credenciales de Binance
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Flash messages -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{% if category == 'error' %}danger{% elif category == 'warning' %}warning{% else %}success{% endif %} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <!-- Current Status -->
                    {% if credentials %}
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-{% if credentials.is_connected %}success{% else %}warning{% endif %}">
                                <div class="card-body text-center">
                                    <i class="fas fa-{% if credentials.is_connected %}check-circle{% else %}exclamation-triangle{% endif %} fa-2x text-{% if credentials.is_connected %}success{% else %}warning{% endif %} mb-2"></i>
                                    <h5 class="card-title">Estado de Conexión</h5>
                                    <p class="card-text">
                                        <span class="badge bg-{% if credentials.is_connected %}success{% else %}warning{% endif %} fs-6">
                                            {% if credentials.is_connected %}Conectado{% else %}Desconectado{% endif %}
                                        </span>
                                    </p>
                                    {% if credentials.last_connection_test %}
                                    <small class="text-muted">
                                        Última prueba: {{ credentials.last_connection_test.strftime('%d/%m/%Y %H:%M:%S') }}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <i class="fas fa-key fa-2x text-info mb-2"></i>
                                    <h5 class="card-title">API Key</h5>
                                    <p class="card-text">
                                        <code class="small">{{ credentials.api_key[:8] }}...{{ credentials.api_key[-8:] }}</code>
                                    </p>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="testConnection()">
                                        <i class="fas fa-plug me-1"></i>Probar Conexión
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Configuration Form -->
                    <form method="POST" action="{{ url_for('save_binance_credentials') }}" id="credentialsForm">
                        <div class="row">
                            <div class="col-12">
                                <h5 class="mb-3">
                                    <i class="fas fa-cog me-2"></i>
                                    {% if credentials %}Actualizar Credenciales{% else %}Configurar Credenciales{% endif %}
                                </h5>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="api_key" class="form-label">
                                        <i class="fas fa-key me-1"></i>API Key
                                    </label>
                                    <input type="text" class="form-control" id="api_key" name="api_key" 
                                           placeholder="Ingresa tu API Key de Binance" 
                                           value="{% if credentials %}{{ credentials.api_key }}{% endif %}"
                                           required>
                                    <div class="form-text">
                                        Tu API Key pública de Binance
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="api_secret" class="form-label">
                                        <i class="fas fa-lock me-1"></i>API Secret
                                    </label>
                                    <input type="password" class="form-control" id="api_secret" name="api_secret" 
                                           placeholder="Ingresa tu API Secret de Binance" 
                                           required>
                                    <div class="form-text">
                                        Tu API Secret privado de Binance
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Security Warning -->
                        <div class="alert alert-warning" role="alert">
                            <h6 class="alert-heading">
                                <i class="fas fa-shield-alt me-2"></i>Importante - Seguridad
                            </h6>
                            <p class="mb-2">
                                • Tus credenciales se almacenan de forma segura y encriptada<br>
                                • Solo se requieren permisos de <strong>trading</strong> y <strong>lectura</strong><br>
                                • <strong>NO</strong> habilites permisos de retiro (withdraw) en Binance<br>
                                • Puedes crear una API Key específica para este bot
                            </p>
                        </div>

                        <!-- Instructions -->
                        <div class="card bg-light mb-4">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-info-circle me-2"></i>¿Cómo obtener tus credenciales de Binance?
                                </h6>
                                <ol class="mb-0">
                                    <li>Ve a <a href="https://www.binance.com/es/my/settings/api-management" target="_blank" class="text-decoration-none">Binance API Management</a></li>
                                    <li>Crea una nueva API Key</li>
                                    <li>Habilita solo los permisos: <strong>Enable Spot & Margin Trading</strong></li>
                                    <li>Copia tu API Key y Secret aquí</li>
                                </ol>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Volver
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>
                                {% if credentials %}Actualizar Credenciales{% else %}Guardar Credenciales{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mb-0">Probando conexión...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function testConnection() {
    // Show loading modal
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    fetch('/test_binance_connection')
        .then(response => response.json())
        .then(data => {
            loadingModal.hide();
            
            // Create alert
            const alertType = data.success ? 'success' : 'danger';
            const alertIcon = data.success ? 'check-circle' : 'exclamation-triangle';
            
            const alertHtml = `
                <div class="alert alert-${alertType} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${alertIcon} me-2"></i>
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Insert alert at the top of the card body
            const cardBody = document.querySelector('.card-body');
            cardBody.insertAdjacentHTML('afterbegin', alertHtml);
            
            // Auto-remove alert after 5 seconds
            setTimeout(() => {
                const alert = cardBody.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
            
            // Refresh the page if connection successful to update status
            if (data.success) {
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        })
        .catch(error => {
            loadingModal.hide();
            console.error('Error:', error);
            
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error al probar la conexión
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const cardBody = document.querySelector('.card-body');
            cardBody.insertAdjacentHTML('afterbegin', alertHtml);
        });
}

// Form validation
document.getElementById('credentialsForm').addEventListener('submit', function(e) {
    const apiKey = document.getElementById('api_key').value.trim();
    const apiSecret = document.getElementById('api_secret').value.trim();
    
    if (!apiKey || !apiSecret) {
        e.preventDefault();
        alert('Por favor completa todos los campos');
        return false;
    }
    
    // Basic API key format validation
    if (apiKey.length < 20) {
        e.preventDefault();
        alert('La API Key parece ser muy corta. Verifica que hayas copiado correctamente.');
        return false;
    }
    
    if (apiSecret.length < 20) {
        e.preventDefault();
        alert('El API Secret parece ser muy corto. Verifica que hayas copiado correctamente.');
        return false;
    }
});
</script>
{% endblock %}